From 2ddf537bc1c11a8b0ddc5339ff27a8bae5cbf523 Mon Sep 17 00:00:00 2001
From: Silime <1776303288@qq.com>
Date: Wed, 24 Aug 2022 08:55:38 +0800
Subject: [PATCH] add nfc support

---
 .../boot/dts/qcom/sdm845-oneplus-common.dtsi  | 34 ++++++++++++++++++-
 arch/arm64/configs/sdm845.config              |  2 ++
 2 files changed, 35 insertions(+), 1 deletion(-)

diff --git a/arch/arm64/boot/dts/qcom/sdm845-oneplus-common.dtsi b/arch/arm64/boot/dts/qcom/sdm845-oneplus-common.dtsi
index badc526e7..f2194c668 100644
--- a/arch/arm64/boot/dts/qcom/sdm845-oneplus-common.dtsi
+++ b/arch/arm64/boot/dts/qcom/sdm845-oneplus-common.dtsi
@@ -419,6 +419,23 @@ zap-shader {
 	};
 };
 
+&i2c3 {
+	status = "okay";
+	nfc@28 {
+		compatible = "nxp,nxp-nci-i2c";
+		reg = <0x28>;
+
+		interrupt-parent = <&tlmm>;
+		interrupts = <63 IRQ_TYPE_LEVEL_HIGH>;
+
+		enable-gpios = <&tlmm 129 GPIO_ACTIVE_HIGH>;
+
+		pinctrl-names = "default";
+		pinctrl-0 = <&nfc_int_active &nfc_enable_active>;
+	};
+
+};
+
 &i2c10 {
 	status = "okay";
 	clock-frequency = <100000>;
@@ -757,7 +774,7 @@ &usb_1_dwc3 {
 	/*
 	 * We don't have the capability to switch modes yet.
 	 */
-	dr_mode = "peripheral";
+	dr_mode = "host";
 
 	/* fastest mode for USB 2 */
 	maximum-speed = "high-speed";
@@ -839,6 +856,21 @@ mux {
 			input-enable;
 		};
 	};
+	
+	nfc_int_active: nfc_int_active {
+		pins = "gpio63";
+		function = "gpio";
+		drive-strength = <6>;
+		bias-pull-up;
+	};
+
+	nfc_enable_active: nfc_enable_active {
+		pins = "gpio12", "gpio129";
+		function = "gpio";
+		drive-strength = <6>;
+		bias-pull-up;
+	};
+
 };
 
 &venus {
diff --git a/arch/arm64/configs/sdm845.config b/arch/arm64/configs/sdm845.config
index 57050c87c..4d3fe1d31 100644
--- a/arch/arm64/configs/sdm845.config
+++ b/arch/arm64/configs/sdm845.config
@@ -8,6 +8,8 @@ CONFIG_HID_RMI=m
 CONFIG_RMI4_CORE=m
 CONFIG_RMI4_I2C=m
 CONFIG_RMI4_F55=y
+CONFIG_NFC_NXP_NCI=m
+CONFIG_NFC_NXP_NCI_I2C=m
 
 # Pocophone F1
 CONFIG_DRM_PANEL_NOVATEK_NT36672A=y
-- 
2.34.1
